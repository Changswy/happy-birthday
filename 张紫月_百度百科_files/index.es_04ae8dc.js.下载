define("wiki-lemma:widget/feature/Audio/ui/index.es",function(e,t,i){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),l=e("wiki-common:widget/lib/jquery/jquery"),c=o(l),a=e("wiki-lemma:widget/lemma_content/configModule/secondsKnowLarge/windowScroll"),u=o(a),h=e("wiki-lemma:widget/feature/Audio/tools/audioHelper.es"),r=o(h),m=e("wiki-lemma:widget/feature/Audio/tools/ttsHelper.es"),v=e("wiki-lemma:widget/feature/Audio/tools/constant.es"),d=e("wiki-lemma:widget/feature/Audio/tools/utils.es"),g=e("wiki-lemma:widget/feature/Audio/tools/event.es"),f=e("wiki-common:widget/util/themeColor.es"),E=o(f),$=e("wiki-common:widget/util/url"),p=o($);d.findIndexPolyfill();var C=function(){function e(t){var i=t.options,o=t.event;n(this,e),this.options=i,this.eventEmitter=o,this.image=i.summaryPic||v.TTS_DEFAULT_AVATAR,this.title=i.lemmaTitle,this.voiceList=v.VOICE_LIST,this.duration=0,this.status="loading",this.showPlayer=!1,this.showVoiceList=!1,this.showVolume=!1,this.pointHeight=8,this.volume=1,this.perVolume=this.volume,this.isPlaying=!1,this.isSupportBlur=d.supportsCSS("filter: blur(15px)"),this.bgType=this.isSupportBlur?"image":"color",this.defaultBgColor="#75ACF7",this.bindElements(),this.bindEvents(),this.bindCoreEvents(),this.render()}return s(e,[{key:"bindCoreEvents",value:function(){var e=this;this.eventEmitter.on(g.CoreEvents.PLAY,function(){e.changeStatus("playing")}),this.eventEmitter.on(g.CoreEvents.PAUSE,function(){e.changeStatus("pause")}),this.eventEmitter.on(g.CoreEvents.UPDATE_DURATION,function(t){var i=t/e.duration;i=i>1?1:i,0===e.duration&&(i=0),e.$curTimeEl.text(d.formatTime(i>=1?e.duration:t)),e.$progressBarEl.css("width",100*i+"%")}),this.eventEmitter.on(g.CoreEvents.LOAD_START,function(){e.changeStatus("loading")}),this.eventEmitter.on(g.CoreEvents.CAN_PLAY,function(){e.changeStatus("playing")}),this.eventEmitter.on(g.CoreEvents.END,function(){e.reset()}),this.eventEmitter.on(g.CoreEvents.VIDEO_TYPE_CHANGE,function(t){var i=t.type;e.updatePosition(i)})}},{key:"hide",value:function(){this.$root.css("display","none")}},{key:"show",value:function(){this.$root.css("display","block")}},{key:"reset",value:function(){var e=this;setTimeout(function(){e.hide(),e.$curTimeEl.text(d.formatTime(0)),e.$progressBarEl.css("width",0),e.isPlaying=!1,e.status="pause",e.changeStatus("pause"),e.showVolume=!1,e.toggleVolume(!1),e.showVoiceList=!1,e.toggleVoiceList(!1)},0)}},{key:"render",value:function(){this.$titleEl.removeClass("default"),this.$titleEl.text(this.title),this.$imageEl.attr("src",this.image).attr("crossOrigin","anonymous"),this.renderVoice(),this.renderProgress()}},{key:"initRender",value:function(){var e=this;this.show(),this.$titleEl.text(""),this.$titleEl.addClass("default"),this.changeStatus("loading"),setTimeout(function(){e.changeStatus("playing"),e.render()},1e3)}},{key:"updatePosition",value:function(e){"vertical"===e?this.$root.removeClass("horizontal").addClass("vertical"):"horizontal"===e?this.$root.removeClass("vertical").addClass("horizontal"):this.$root.removeClass("vertical").removeClass("horizontal").addClass("normal")}},{key:"renderVoice",value:function(){var e=this,t=m.voiceHelp.getLocalId();t&&this.voiceList.map(function(e){return e.isSelected=e.onlineId===t?1:0});var i=this.voiceList.map(function(t){return e.renderVoiceItem(t)});this.$voiceEl.html(i.join(""))}},{key:"updateVoice",value:function(){var e=this;this.voiceList.forEach(function(t){var i=e.$voiceEl.find("div[data-onlineid='"+t.onlineId+"']");i.removeClass("active"),t.isSelected&&i.addClass("active")})}},{key:"renderVoiceItem",value:function(e){var t=["voice-item",e.isSelected?"active":""].join(" ");return'<div class="'+t+'" data-onlineid="'+e.onlineId+'">\n            <img class="voice-image" src="'+e.coverImg+'" alt="">\n            <div class="voice-border"></div>\n            <div class="voice-checked"></div>\n            <div class="voice-title">'+e.displayName+"</div>\n        </div>"}},{key:"renderProgress",value:function(){var e=this.options,t=r["default"]({lemmaTitle:e.lemmaTitle||"",pinyin:e.pinyin&&e.pinyin[0]||"",catalog:e.catalog||[],extData:e.modulesData||{}}),i=t.letterCount;this.duration=Math.ceil(i/5),this.$curTimeEl.text(d.formatTime(0)),this.$endTimeEl.text(d.formatTime(+this.duration)),this.$progressBarEl.css("width",0)}},{key:"changeStatus",value:function(e){"loading"===e&&(this.$el.toggleClass("loading"),this.$el.removeClass("playing")),"playing"===e&&(this.$el.addClass("playing"),this.$el.removeClass("loading"),this.$playIconEl.removeClass("continue")),"pause"===e&&(this.$el.removeClass("playing"),this.$playIconEl.addClass("continue"))}},{key:"toggleVoiceList",value:function(e){this.$voiceEl.find(".voice-item").length&&(e?(this.$el.addClass("show-voice"),this.$voiceChooseEl.css("display","flex"),this.$voiceChangeIconEl.addClass("active-icon")):(this.$el.removeClass("show-voice"),this.$voiceChooseEl.css("display","none"),this.$voiceChangeIconEl.removeClass("active-icon")))}},{key:"toggleVolume",value:function(e){if(e){this.$volumeEl.css("display","block"),this.$voiceVolumeIconEl.addClass("active-icon");var t=this.$volumeBarEl[0].getBoundingClientRect(),i=t.height*this.volume;i>=t.height-this.pointHeight&&(i=t.height-this.pointHeight),this.$volumePointEl.css("bottom",i+"px"),this.$volumeActiveBarEl.css("height",t.height*this.volume+"px")}else this.$volumeEl.css("display","none"),this.$voiceVolumeIconEl.removeClass("active-icon")}},{key:"calcVolume",value:function(e){var t=this.$volumeBarEl[0].getBoundingClientRect(),i=t.bottom-e;0>=i?i=0:i>t.height-this.pointHeight&&(i=t.height-this.pointHeight),this.$volumePointEl.css("bottom",i+"px"),this.$volumeActiveBarEl.css("height",i+this.pointHeight+"px");var o=i/(t.height-this.pointHeight);this.volume=o,this.changeVoiceMute(0===this.volume),this.eventEmitter.emit(g.UIEvents.VOLUME_CHANGE,o)}},{key:"toggleMuteVolume",value:function(e){var t=this.$volumeBarEl[0].getBoundingClientRect(),i=(t.height-this.pointHeight)*e;this.$volumePointEl.css("bottom",i+"px"),this.$volumeActiveBarEl.css("height",i+this.pointHeight+"px"),this.preVolume=this.volume,this.volume=e,this.changeVoiceMute(0===this.volume),this.eventEmitter.emit(g.UIEvents.VOLUME_CHANGE,e)}},{key:"changeVoiceMute",value:function(e){this.$el.toggleClass("mute",e)}},{key:"close",value:function(){this.reset(),this.eventEmitter.emit(g.UIEvents.CLOSE_CLICK,{})}},{key:"setImageStyle",value:function(){var e=this.$imageEl[0].naturalWidth,t=this.$imageEl[0].naturalHeight,i=e/t,o=i>1?"auto":"100%",n=i>1?"100%":"auto";this.$imageEl.width(o),this.$imageEl.height(n),this.setBgStyle()}},{key:"setBgStyle",value:function(){var e=this,t=p["default"].getQuery("ttsbgtype")||this.bgType;if("color"===t&&E["default"]&&"function"==typeof E["default"])try{E["default"](this.$imageEl[0],function(t){var i=(t.colorArr,t.colorAvg);e.$bgImgEl.css("background-color","rgb("+i.join(",")+")")})}catch(i){this.$bgImgEl.css("background-color",this.defaultBgColor)}else this.$bgImgEl.css("background-image","url("+this.image+")"),this.$bgImgEl.addClass("blur")}},{key:"bindElements",value:function(){this.$root=c["default"]("#J-tts"),this.$el=this.$root.find(".tts-container"),this.$imageEl=this.$el.find(".image"),this.$titleEl=this.$el.find(".title"),this.$bgImgEl=this.$el.find(".background"),this.$playIconEl=this.$el.find(".play-icon"),this.$nextIconEl=this.$el.find(".next-icon"),this.$closeIconEl=this.$el.find(".close-icon"),this.$voiceChangeIconEl=this.$el.find(".voice-icon"),this.$voiceVolumeIconEl=this.$el.find(".volume-icon"),this.$voiceMuteEl=this.$el.find(".ctrl-icon"),this.$curTimeEl=this.$el.find(".current-time"),this.$endTimeEl=this.$el.find(".end-time"),this.$progressContainerEl=this.$el.find(".progress-bar"),this.$progressBarEl=this.$el.find(".progress-bar-inner"),this.$voiceVolumeEl=this.$el.find(".volume-container"),this.$volumeEl=this.$el.find(".voice-volume"),this.$volumePointEl=this.$el.find(".volume-point"),this.$volumeBarEl=this.$el.find(".volume-bar"),this.$volumeActiveBarEl=this.$el.find(".volume-active-bar"),this.$voiceChooseEl=this.$el.find(".tts-voice"),this.$voiceChooseLeftIcon=this.$el.find(".left-icon"),this.$voiceChooseRightIcon=this.$el.find(".right-icon"),this.$voiceEl=this.$el.find(".voice-list")}},{key:"bindEvents",value:function(){var e=this,t=this;this.$titleEl.on("click",function(){e.eventEmitter.emit(g.UIEvents.TITLE_CLICK,{})}),this.$playIconEl.on("click",function(){e.isPlaying?e.eventEmitter.emit(g.UIEvents.PAUSE_CLICK,{}):e.eventEmitter.emit(g.UIEvents.PLAY_CLICK,{})}),this.$voiceChangeIconEl.on("click",function(){e.showVoiceList=!e.showVoiceList,e.showVolume=!1,e.toggleVolume(!1),e.toggleVoiceList(e.showVoiceList)}),this.$voiceEl.on("click",".voice-item",function(){var e=c["default"](this).data("onlineid"),i=t.voiceList.findIndex(function(t){return t.onlineId===parseInt(e,10)});t.voiceList.map(function(e){return e.isSelected=0}),t.voiceList[i].isSelected=1,t.updateVoice(),t.eventEmitter.emit(g.UIEvents.VOICE_CHOOSE,t.voiceList[i])}),this.$voiceChooseLeftIcon.on("click",function(t){t.stopPropagation(),e.$voiceEl[0].scrollTo({left:0,behavior:"smooth"})}),this.$voiceChooseRightIcon.on("click",function(t){t.stopPropagation(),e.$voiceEl[0].scrollTo({left:1e3,behavior:"smooth"})}),this.$voiceVolumeIconEl.on("click",function(){e.showVolume=!e.showVolume,e.showVoiceList=!1,e.toggleVoiceList(!1),e.toggleVolume(e.showVolume)}),this.$volumeBarEl.on("click",function(t){e.calcVolume(t.clientY)}),this.$volumePointEl.on("mousemove",function(t){e._voiceColumnTouching&&e.calcVolume(t.clientY)}),this.$volumePointEl.on("mousedown",function(t){t.stopPropagation(),e._voiceColumnTouching=!0}),this.$voiceMuteEl.on("click",function(){e.toggleMuteVolume(e.volume>0?0:e.preVolume)}),this.$closeIconEl.on("click",function(){e.close()}),this.$imageEl.on("load",function(){e.setImageStyle()}),c["default"]("body").on("mousemove",function(t){e._voiceColumnTouching&&e.calcVolume(t.clientY)}),c["default"]("body").on("mouseup",function(){e._voiceColumnTouching=!1}),c["default"]("body").on("click",function(t){var i=c["default"](t.target);e._voiceColumnTouching||i.parents().hasClass("volume-container")||(e.showVolume=!1,e.toggleVolume(!1))}),this.$root.on("mousedown",function(e){var t=0,i=0,o=void 0,n=void 0,s=e||window.event;t=s.clientX-c["default"](this)[0].offsetLeft,i=s.clientY-c["default"](this)[0].offsetTop;var l=c["default"](this);document.onmousemove=function(e){u["default"].disableScroll();var s=e||window.event,a=s.clientX-t,h=s.clientY-i;0>a&&(a=0);var r=l.width();a>document.documentElement.clientWidth-r&&(a=document.documentElement.clientWidth-r);var m=l.height();h>document.documentElement.clientHeight-m&&(h=document.documentElement.clientHeight-m),0>h&&(h=0),l[0].style.left=a+"px",l[0].style.top=h+"px",d.isCollide(l[0],c["default"](".sl-player-el-container")[0])?(o=a,n=h):(l[0].style.left=o+"px",l[0].style.top=n+"px")},document.onmouseup=function(){u["default"].enableScroll(),document.onmousemove=null,document.onmouseup=null}})}}]),e}();t["default"]=C,i.exports=t["default"]});