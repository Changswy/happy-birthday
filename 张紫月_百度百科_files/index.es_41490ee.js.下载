define("wiki-lemma:widget/feature/Audio/core/index.es",function(t,a,i){"use strict";function e(t){return t&&t.__esModule?t:{"default":t}}function l(t){this.lemmaId=t.lemmaId||"",this.lemmaTitle=t.lemmaTitle||"",this.catalog=t.catalog||[],this.$panel=s["default"]("#J-audio-container"),this.$toggleBtn=this.$panel.find("#J-audio-stop"),this.$audio=this.$panel.find(".J-audio-core"),this.soundId=p.voiceHelp.getLocalId()||4100,this.isPlaying=!1,this.pidList=[],this.curCatalogPid="",this.playDuration=0,this.playCurTime=0,this.voiceData=u["default"]({lemmaTitle:t.lemmaTitle||"",pinyin:t.pinyin&&t.pinyin[0]||"",catalog:t.catalog||[],extData:t.modulesData||{}}).voiceData,this.currnetIndex=0,this.currentVoiceIdx=0,this.delayFlag,this.partTitleFlag,this.headerFlag,this.titleFlag,this.isFirstPlay=!0,this.playerId=0,this.safariAudio=null,this.bindUIEvent(),this.bindAudioEvent(),this.bindEvent(),this.initPlayer()}function o(t){return A||(A=new C["default"]({options:t,event:w})),D||(D=new l(t)),D}var n=t("wiki-common:widget/lib/jquery/jquery"),s=e(n),d=t("wiki-lemma:widget/feature/Audio/tools/audioHelper.es"),u=e(d),r=t("wiki-common:widget/component/evtMsgManager/evtMsgManager.es"),c=e(r),h=t("wiki-common:widget/util/eventEmitter"),g=e(h),f=t("wiki-lemma:widget/feature/Audio/tools/constant.es"),m=t("wiki-lemma:widget/feature/Audio/tools/utils.es"),p=t("wiki-lemma:widget/feature/Audio/tools/ttsHelper.es"),y=t("wiki-lemma:widget/feature/Audio/tools/event.es"),P=t("wiki-lemma:widget/tools/clickstream/clickstream"),v=e(P),I=t("wiki-lemma:widget/feature/Audio/ui/index.es"),C=e(I),E=t("wiki-common:widget/util/cookie"),x=e(E),T=c["default"].Events,w=new g["default"],D=void 0,A=void 0;m.findIndexPolyfill(),l.prototype={initPlayer:function(){this.registerPlayerId(),this.watchPlayingId(),this.safariInit()},registerPlayerId:function(){this.playerId=Date.now().toString()+Math.floor(1e3*Math.random()).toString()},writePlyingCookie:function(){this.isFirstPlay=!1,x["default"].set(f.TTS_PLAYER_COOKIE,this.playerId,{domain:"baidu.com",path:"/"})},watchPlayingId:function(){var t=this;setInterval(function(){var a=x["default"].get(f.TTS_PLAYER_COOKIE);t.playerId!==a&&t.isPlaying&&(t.isPlaying=!1,t.setIsplayingStatus(!1),t.togglePlay("pause"))},300)},safariInit:function(){if(m.isSafari()){var t=document.createElement("audio");t.muted=!0,t.autoplay=!0,t.src=f.AUDIO_NULL_SRC,this.safariAudio=t,document.body.appendChild(this.safariAudio)}},safariPlay:function(){if(m.isSafari()&&this.isFirstPlay)try{this.safariAudio.play(),s["default"](this.safariAudio).remove(),this.isFirstPlay=!1}catch(t){console.error(t)}},bindAudioEvent:function(){var t=this,a=s["default"](".J-audio-core");a&&(a.on("ended",function(){t.playDuration+=this.duration,w.emit(y.CoreEvents.UPDATE_DURATION,t.playDuration)}),a.on("timeupdate",function(){t.playCurTime=0===this.currentTime?t.playDuration:t.playDuration+this.currentTime,w.emit(y.CoreEvents.UPDATE_DURATION,t.playCurTime)}))},bindUIEvent:function(){var t=this;w.on(y.UIEvents.TITLE_CLICK,function(){t.jumpToPos()}),w.on(y.UIEvents.PLAY_CLICK,function(){t.playControl()}),w.on(y.UIEvents.PAUSE_CLICK,function(){t.playControl()}),w.on(y.UIEvents.VOLUME_CHANGE,function(a){t.changeVolume(a)}),w.on(y.UIEvents.VOICE_CHOOSE,function(a){var i=a.onlineId;t.replayCurPid(i)}),w.on(y.UIEvents.CLOSE_CLICK,function(){t.stopPlay()})},changeVolume:function(t){var a=s["default"](".J-audio-core");a&&a.each(function(a,i){i.volume=t})},toggleAudioUI:function(t){A&&(t&&A.show(),!t&&A.hide())},setIsplayingStatus:function(t){this.isPlaying=t,t&&c["default"].trigger(c["default"].Events.LEMMA_AUDIO_PLAY),w.emit(t?y.CoreEvents.PLAY:y.CoreEvents.PAUSE),this.allPlayPauseStyle()},addPidList:function(t){this.pidList.push(t),this.curCatalogPid=this.voiceData[this.getVoiceIndex(t)].catalogPid,this.pidListChange(t)},getCurrentPid:function(){return this.pidList[this.pidList.length-1]},playFromStart:function(){this.click2Play(),this.addPidList(0)},togglePlay:function(t){switch(t){case"play":0===this.currnetIndex,this.toggleCatalogStyle(this.getDomByPid(this.curCatalogPid)),this.pidList.length?s["default"]("#J-audio-current")[0].play():this.playFromStart(),this.writePlyingCookie(),w.emit(y.CoreEvents.PLAY);break;case"pause":this.toggleCatalogStyle(this.getDomByPid(this.curCatalogPid),!1),s["default"]("#J-audio-current")[0].pause(),w.emit(y.CoreEvents.PAUSE)}},playControl:function(){var t=this;this.isPlaying?(this.setIsplayingStatus(!1),this.togglePlay("pause")):(this.pidList.length||(this.toggleAudioUI(!0),v["default"].logViewEl({page:"lemma",element:"audio-bar",lemmaTitle:this.lemmaTitle,lemmaId:this.lemmaId})),m.isSafari()&&this.isFirstPlay&&this.safariAudio?(this.safariPlay(),setTimeout(function(){t.setIsplayingStatus(!0),t.togglePlay("play")},300)):(this.setIsplayingStatus(!0),this.togglePlay("play")))},click2Play:function(){this.playCurrent(),this.calcIndex(),this.cacheNext()},autoPlay:function(){this.toggleAudioId(),this.playCurrent(),this.calcIndex(),this.cacheNext()},calcIndex:function(){var t=this.voiceData[this.currnetIndex].voice;this.currentVoiceIdx<t.length-1?this.currentVoiceIdx++:(this.currnetIndex++,this.currentVoiceIdx=0)},playCurrent:function(){var t=this,a=this.voiceData[this.currnetIndex];p.getTTSUrl(a.voice[this.currentVoiceIdx],this.soundId).then(function(a){s["default"]("#J-audio-current").attr("src",a,0===t.currnetIndex),s["default"]("#J-audio-current")[0].play(),t.setIsplayingStatus(!0)})},cacheNext:function(){var t=this,a=this.voiceData[this.currnetIndex];a&&p.getTTSUrl(a.voice[this.currentVoiceIdx],this.soundId).then(function(a){s["default"]("#J-audio-cache").attr("src",a,0===t.currnetIndex),s["default"]("#J-audio-cache")[0].load()})},stopPlay:function(){this.isPlaying=!1,this.togglePlay("pause"),this.allPlayPauseStyle();var t=this.getCurrentPid();this.getDomByPid(t)&&this.togglePlayTextColor(this.getDomByPid(t),!1),this.curCatalogPid="",this.pidList=[],this.currnetIndex=0,this.currentVoiceIdx=0,this.delayFlag=void 0,this.partTitleFlag=void 0,this.headerFlag=void 0,this.titleFlag=void 0,this.playDuration=0,c["default"].trigger(c["default"].Events.LEMMA_AUDIO_PAUSE),w.emit(y.CoreEvents.END)},toggleAudioId:function(){s["default"]("#J-audio-current").attr("id","J-audio-old"),s["default"]("#J-audio-cache").attr("id","J-audio-current"),s["default"]("#J-audio-old").attr("id","J-audio-cache")},getVoiceIndex:function(t){var a=-1;return this.voiceData.forEach(function(i,e){i.pid===t&&(a=e)}),a},getDomByPid:function(t){return s["default"]('[data-pid="'+t+'"]')},replayCurPid:function(t){this.soundId=t,p.voiceHelp.setLocalId(t),this.currnetIndex=this.getVoiceIndex(this.getCurrentPid()),this.currentVoiceIdx=0,this.playCurrent(),this.calcIndex(),this.cacheNext()},togglePlayTextColor:function(t){var a=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];t&&(a?t.addClass("currnet-audio-para"):t.removeClass("currnet-audio-para"))},toggleCatalogStyle:function(t){var a=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];if(t&&t.length){var i=t.find(".J-part-audio-play").find("em"),e=t.find(".J-part-audio-play").find(".J-part-audio-text");a?(t.addClass("cur-play-catalog"),e.text("暂停"),i.removeClass("wiki-lemma-icons_voice-play").addClass("wiki-lemma-icons_audio-pause")):(t.removeClass("cur-play-catalog"),e.text("播报"),i.removeClass("wiki-lemma-icons_audio-pause").addClass("wiki-lemma-icons_voice-play"))}},toggleHeaderStyle:function(){var t=s["default"](".J-header-audio-play").find("em"),a=s["default"](".J-header-audio-play").find(".J-audio-text");this.isPlaying?(s["default"](".J-header-audio-play").css("color","#459DF5"),a.text("暂停"),t.removeClass("wiki-lemma-icons_voice-play").addClass("wiki-lemma-icons_audio-pause")):(s["default"](".J-header-audio-play").css("color",""),a.text("播报"),t.removeClass("wiki-lemma-icons_audio-pause").addClass("wiki-lemma-icons_voice-play"))},toggleTitleStyle:function(){var t=s["default"](".J-title-audio-play").find("em"),a=s["default"](".J-title-audio-play").find(".J-audio-text");this.isPlaying?(a.text("暂停"),t.removeClass("wiki-lemma-icons_voice-play").addClass("wiki-lemma-icons_audio-pause")):(a.text("播报"),t.removeClass("wiki-lemma-icons_audio-pause").addClass("wiki-lemma-icons_voice-play"))},allPlayPauseStyle:function(){this.toggleHeaderStyle(),this.toggleTitleStyle()},pidListChange:function(t){var a=this.getDomByPid(this.pidList[this.pidList.length-2]),i=this.getDomByPid(t);this.togglePlayTextColor(a,!1),this.togglePlayTextColor(i);var e=this.voiceData[this.getVoiceIndex(t)],l=this.pidList[this.pidList.length-2],o=l?this.voiceData[this.getVoiceIndex(l)].catalogPid:null;e.catalogPid&&e.catalogPid!==o?(o&&this.toggleCatalogStyle(this.getDomByPid(o),!1),this.toggleCatalogStyle(this.getDomByPid(e.catalogPid))):e.catalogPid||o&&this.toggleCatalogStyle(this.getDomByPid(o),!1)},getPlayTotal:function(t){var a=this.voiceData,i=a.findIndex(function(a){return a.pid===t}),e=0;a.forEach(function(t,a){i>a&&(e+=m.getStrArrayCount(t.voice))}),this.playDuration=Math.ceil(e/5),w.emit(y.CoreEvents.UPDATE_DURATION,this.playDuration)},jumpToPos:function(){var t=this.getCurrentPid(),a=this.getDomByPid(t),i=60,e=a[0].getBoundingClientRect(),l=document.body.scrollTop||document.documentElement.scrollTop;window.scrollTo(0,e.top+l-i)},bindEvent:function(){var t=this;s["default"]("body").on("click",".J-para-audio-play , .para-title[data-pid]",function(a){if(s["default"](a.target).hasClass("J-part-audio-play")||s["default"](a.target).hasClass("wiki-lemma-icons_voice-play")||s["default"](a.target).hasClass("J-part-audio-text")||s["default"](a.target).hasClass("J-para-audio-play")){t.writePlyingCookie();var i=s["default"](this).data("pid");if(t.getPlayTotal(i),i!==t.getCurrentPid()){var e=t.getVoiceIndex(i);e!==t.getVoiceIndex(t.getCurrentPid())&&(t.setIsplayingStatus(!0),t.addPidList(i),t.currnetIndex=e,t.currentVoiceIdx=0,t.click2Play())}else t.replayCurPid(t.soundId)}}),s["default"]("body").on("mouseenter","[data-pid]",function(){var a=this;!t.pidList.length||s["default"](this).hasClass("J-para-audio-play ")||s["default"](this).hasClass("wiki-lemma-icons_voice-play")||s["default"](this).hasClass("level-2")||s["default"](this).attr("audio-id")||0===s["default"](this).data("pid")||"card"===s["default"](this).data("pid")||!s["default"](this).find(".J-para-audio-play ")||!function(){s["default"](a).addClass("audio-hover-bg");var i=s["default"](a).data("pid"),e='<em data-pid="'+i+'" \n                        class="para-audio-play J-para-audio-play cmn-icon wiki-lemma-icons wiki-lemma-icons_voice-play"\n                    ></em>';clearTimeout(t.delayFlag),t.delayFlag=setTimeout(function(){var t=void 0;if(s["default"](a).hasClass("level-3"))s["default"](a).find(".title-text").append(e),s["default"](a).find(".J-para-audio-play ").fadeIn();else if(s["default"](a).hasClass("para-list")&&1===s["default"](a).children().length&&s["default"](a).find(".list-dot ").find(".para").length)s["default"](a).find(".para").append(e),s["default"](a).find(".J-para-audio-play ").fadeIn();else{for(var i=s["default"](a)[0].childNodes,l=i.length-1;l>=0&&!t;){var o=s["default"](i[l]);o.hasClass("lemma-album")||o.hasClass("lemma-album-marquee")||o.hasClass("lemma-picture")||3===i[l].nodeType&&""===i[l].textContent.replace(/\s/g,"")?l--:t=o}t?s["default"](e).insertAfter(t):s["default"](a).append(e),s["default"](a).find(".J-para-audio-play ").fadeIn()}},0),s["default"](a).on("mouseleave",function(){var a=this;setTimeout(function(){s["default"](a).removeClass("audio-hover-bg"),s["default"](a).find(".J-para-audio-play ").fadeOut().remove(),clearTimeout(t.delayFlag)},200),s["default"](this).off("mouseleave")})}()}),s["default"](".J-audio-core").on("ended",function(){if(0===t.currentVoiceIdx&&t.currnetIndex<t.voiceData.length){var a=t.voiceData[t.currnetIndex].pid;t.addPidList(a)}else if(t.currnetIndex>=t.voiceData.length)return t.stopPlay(),s["default"]("#J-audio-current").attr("src",""),void s["default"]("#J-audio-cache").attr("src","");t.autoPlay()}),s["default"]("#J-audio-stop").on("click",function(){t.playControl()}),s["default"](".J-header-audio-play").on("click",function(){t.playControl(),v["default"].logActClick({page:"lemma",element:"audio-header-play",status:t.isPlaying?"play":"pause",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId})}),s["default"](".J-title-audio-play").on("click",function(){t.playControl(),v["default"].logActClick({page:"lemma",element:"audio-title-play",status:t.isPlaying?"play":"pause",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId})}),s["default"](".J-part-audio-play").on("click",function(a){t.writePlyingCookie(),t.pidList.length||(t.isFirstPlay=!0,t.safariPlay(),t.toggleAudioUI(!0),v["default"].logViewEl({page:"lemma",element:"audio-bar",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId}));var i=s["default"](this).parent(".para-title").data("pid"),e=!1,l=t.getCurrentPid();l&&(e=i===t.voiceData[t.getVoiceIndex(l)].catalogPid),t.isPlaying?e&&(a.stopPropagation(),t.setIsplayingStatus(!1),t.togglePlay("pause")):(t.setIsplayingStatus(!0),e&&(a.stopPropagation(),t.togglePlay("play"))),v["default"].logActClick({page:"lemma",element:"audio-catalog-play",status:t.isPlaying?"play":"pause",lemmaTitle:t.lemmaTitle,lemmaId:t.lemmaId})}),c["default"].on(T.LEMMA_VIDEO_PLAY,function(){t.isPlaying=!1,t.togglePlay("pause"),t.allPlayPauseStyle()}),c["default"].on(T.LEMMA_VIDEO_PAUSE,function(){!t.pidList.length||0===t.currnetIndex&&0===t.currentVoiceIdx||(t.isPlaying=!0,t.togglePlay("play"),t.allPlayPauseStyle())}),c["default"].on("SHOW_WINDOW_VIDEO",function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];w.emit(y.CoreEvents.VIDEO_TYPE_CHANGE,t)}),c["default"].on("HIDE_WINDOW_VIDEO",function(){w.emit(y.CoreEvents.VIDEO_TYPE_CHANGE,{type:"normal"})}),s["default"]("#J-audio-close").on("click",function(){t.stopPlay()})},unBindEvent:function(){}},i.exports=o});